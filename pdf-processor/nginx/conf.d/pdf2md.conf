# HTTP Server (Port 8080) - Redirect to HTTPS
server {
    listen 8080;
    server_name _;

    location / {
        return 301 https://$host:8443$request_uri;
    }
}

# HTTPS Server (Port 8443) - Main Application
server {
    listen 8443 ssl;
    http2 on;
    server_name _;

    # TLS Configuration
    include /etc/nginx/snippets/ssl-params.conf;
    ssl_certificate /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;

    # Security Headers
    include /etc/nginx/snippets/security-headers.conf;

    # Welcome page
    location = / {
        default_type text/plain;
        return 200 "pdf2md stack is running.\n\nAPI docs: /api/docs\nDownloads: /downloads/\nRedis Admin: /redis-admin/ (Basic Auth)\n";
    }

    # API proxy (strip /api prefix and forward to backend)
    location /api/ {
        include /etc/nginx/snippets/proxy-params.conf;
        rewrite ^/api/?(.*)$ /$1 break;
        proxy_pass http://pdf2md-api:8000;
    }

    # Static downloads from results volume
    location /downloads/ {
        alias /var/www/downloads/;
        autoindex on;
        autoindex_exact_size off;
        autoindex_localtime on;
        types {
            text/plain md;
            text/plain txt;
        }
        default_type text/plain;
        limit_except GET HEAD {
            deny all;
        }
    }

    # Redis Commander behind Basic Auth at /redis-admin/
    location /redis-admin/ {
        auth_basic "Redis Admin";
        auth_basic_user_file /etc/nginx/auth/redis-admin.htpasswd;

        include /etc/nginx/snippets/proxy-params.conf;

        # Commander serves at / by default; strip /redis-admin prefix
        rewrite ^/redis-admin/?(.*)$ /$1 break;
        proxy_pass http://pdf2md-redis-commander:8081;

        # Handle redirects under prefix
        proxy_redirect ~^(/.*)$ /redis-admin$1;
    }
}

# Optional: mTLS Server (Port 8444) - For high-security service-to-service auth
# Uncomment to enable mTLS endpoint
# Requires: certs/ca-cert.pem (CA certificate for client verification)
#
# server {
#     listen 8444 ssl http2;
#     server_name _;
#
#     # TLS Configuration
#     include /etc/nginx/snippets/ssl-params.conf;
#     ssl_certificate /etc/nginx/certs/fullchain.pem;
#     ssl_certificate_key /etc/nginx/certs/privkey.pem;
#
#     # Client certificate verification (mTLS)
#     ssl_client_certificate /etc/nginx/certs/ca-cert.pem;
#     ssl_verify_client on;
#     ssl_verify_depth 2;
#
#     # Pass client cert info to backend
#     proxy_set_header X-SSL-Client-Cert $ssl_client_cert;
#     proxy_set_header X-SSL-Client-DN $ssl_client_s_dn;
#     proxy_set_header X-SSL-Client-Verify $ssl_client_verify;
#
#     # Security Headers
#     include /etc/nginx/snippets/security-headers.conf;
#
#     # mTLS API proxy
#     location /mtls/ {
#         include /etc/nginx/snippets/proxy-params.conf;
#         rewrite ^/mtls/?(.*)$ /$1 break;
#         proxy_pass http://pdf2md-api:8000;
#     }
# }